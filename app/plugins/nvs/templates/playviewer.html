{% load static %}
{% load extras %}
<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="apple-touch-icon" sizes="180x180" href="/static/img/icon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/static/img/icon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/static/img/icon/favicon-16x16.png">
        <link rel="manifest" href="/static/img/icon/site.webmanifest">
        <link rel="mask-icon" href="/static/img/icon/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="theme-color" content="#ffffff">

        <!-- CSS -->
        <link href="{% static 'css/fontawesome.min.css' %}" rel="stylesheet">
        <link href="{% static 'css/regular.min.css' %}" rel="stylesheet">
        <link href="{% static 'css/solid.min.css' %}" rel="stylesheet">
        <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
        <!--<link href="{% static 'css/nvs.css' %}" rel="stylesheet">-->

        <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital@0;1&display=swap" rel="stylesheet">
        <style title="main-sheet">
            /* -----------------------------
            || MAIN CSS VARIABLES
            || -------------------------- */
            :root {
                --scrollbarURL: url("/corpus/{{ corpus_id }}/play-minimap/{{ play.prefix }}/?width=60&height=1000");
                --nvs-form-control-height: 35px;
                --nvs-play-row-min-height: 40px;
                --nvs-form-control-font-size: 12px;
                --nvs-background-color: #FFFFFF;
                --nvs-lightest-gray: #F2F2F2;
                --nvs-lighter-gray: #C4C4C4;
                --nvs-mid-gray: #828282;
                --nvs-dark-blue: #085294;
                --nvs-primary-orange: #CC5F38;
                --nvs-secondary-orange: #F1B06E;
                --nvs-light-beige: #FBF5F1;
                --nvs-dark-beige: #EBE4DD;
            }

            body {
                background-color: #FFFFFF;
            }

            canvas {
                display: block;
            }

            /* -----------------------------
            || HEADERS AND CONTROLS
            || -------------------------- */

            .bg-nvs-lightest-gray {
                background-color: var(--nvs-lightest-gray);
            }

            .heading-section-label {
                font-family: 'Roboto', sans-serif;
                color: var(--nvs-dark-blue);
                font-size: 14px;
                font-weight: bold;
            }

            .heading-label {
                font-family: 'Roboto', sans-serif;
                color: var(--nvs-mid-gray);
                font-size: 14px;
                font-weight: bold;
            }

            .view-col {
                border-left: solid 5px var(--nvs-background-color);
                border-right: solid 5px var(--nvs-background-color);
            }

            .nvs-selection {
                position: relative;
            }

            .nvs-selection:after {
                content: '\f0d7';
                font-family: "Font Awesome 5 Free";
                font-weight: 900;
                font-size: 25px;
                color: var(--nvs-lighter-gray);
                right: 10px;
                top: 4px;
                height: 35px;
                position: absolute;
                pointer-events: none;
            }

            select::-ms-expand {
                display: none;
            }

            .nvs-search, .nvs-selection select, input[type=text], input[type=button] {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                /* Add some styling */

                display: block;
                width: 100%;
                height: var(--nvs-form-control-height);
                float: right;
                margin: 2.5px 0px;
                padding: 0px 10px;
                font-size: var(--nvs-form-control-font-size);
                line-height: 1;
                color: #333;
                background-color: #ffffff;
                background-image: none;
                border: 1px solid var(--nvs-lighter-gray);
                -ms-word-break: normal;
                word-break: normal;
            }

            .nvs-selection select {
                font-size: 16px;
            }

            .nvs-search {
                position: relative;
                height: unset;
                min-height: var(--nvs-form-control-height);
                padding: 10px;
                max-height: 150px;
                overflow-x: hidden;
                overflow-y: auto;
            }

            .nvs-search:empty:before{
                content: attr(placeholder);
                color: var(--nvs-mid-gray);
                pointer-events: none;
                display: block;
            }

            .nvs-search:empty:after {
                content: '\f002';
                font-family: "Font Awesome 5 Free";
                font-weight: 900;
                font-size: 18px;
                color: var(--nvs-lighter-gray);
                right: 10px;
                top: 6px;
                height: 35px;
                position: absolute;
                pointer-events: none;
            }

            input[type=button] {
                cursor: pointer;
                background-color: var(--nvs-primary-orange);
                color: var(--nvs-background-color);
            }

            input.nvs-secondary-button {
                background-color: var(--nvs-secondary-orange);
            }

            input[type=checkbox] {
                height: 20px;
                left: 0;
                opacity: 0;
                position: absolute;
                top: 0;
                width: 30px;
            }

            .toggle-control {
                display: block;
                position: relative;
                padding-left: 40px;
                cursor: pointer;
                font-size: 22px;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            .toggle-control input {
                position: absolute;
                opacity: 0;
                cursor: pointer;
                height: 0;
                width: 0;
            }
            .toggle-control input:checked ~ .control {
                background-color: var(--nvs-primary-orange);
            }
            .toggle-control input:checked ~ .control:after {
                left: 22px;
            }
            .toggle-control .control {
                position: absolute;
                top: 0;
                left: 0;
                height: 20px;
                width: 40px;
                border-radius: 10px;
                background-color: var(--nvs-mid-gray);
                -webkit-transition: background-color 0.15s ease-in;
                transition: background-color 0.15s ease-in;
            }
            .toggle-control .control:after {
                content: "";
                position: absolute;
                left: 2px;
                top: 2px;
                width: 16px;
                height: 16px;
                border-radius: 10px;
                background: var(--nvs-background-color);
                -webkit-transition: left 0.15s ease-in;
                transition: left 0.15s ease-in;
            }
            .toggle-control .heading-label {
                position: relative;
                top: -10px;
                left: 10px;
            }
            label.toggle-control {
                margin-bottom: 0px!important;
            }

            /* -----------------------------
            || PLAY READER VIEW
            || -------------------------- */

            #witness-header {
                height: var(--nvs-form-control-height);
                width: 100%;
            }

            #playtext-col {
                overflow-y: scroll;
                max-height: 100vh;
                background-repeat: no-repeat;
            }

            #playtext-col::-webkit-scrollbar {
                width: 60px;
            }

            #playtext-col::-webkit-scrollbar-track {
                background-image: var(--scrollbarURL);
                background-size: contain;
                background-repeat: no-repeat;
            }

            #playtext-col::-webkit-scrollbar-thumb {
                background-color: rgba(247, 155, 86, .5);
            }

            .play-row {
                border-bottom: solid 4px #fbeee0;
                min-height: var(--nvs-play-row-min-height);
            }

            .play-label {
                background-color: var(--nvs-light-beige);
                font-family: 'Roboto', sans-serif;
                font-size: 1.2vw;
                border: none;
                -webkit-box-align: center!important;
                -ms-flex-align: center!important;
                align-items: center!important;
                display: -webkit-box!important;
                display: -ms-flexbox!important;
                display: flex!important;
            }

            .play-words, .play-words-seen {
                padding-top: 10px;
                padding-bottom: 5px;
                font-family: 'Libre Baskerville', serif;
                font-size: 1.3vw;
                color: #070707;
                background-color: var(--nvs-background-color);
                -webkit-box-align: center!important;
                -ms-flex-align: center!important;
                align-items: center!important;
                display: -webkit-box!important;
                display: -ms-flexbox!important;
                display: flex!important;
            }

            .offscreen > .play-words > .line-html, .offscreen + .variant-drawer, .offscreen canvas {
                display: none;
            }

            .onscreen > .play-words > .line-text {
                display: none;
            }

            span.castgroup {
                margin-left: 10px;
            }

            span.role {
                font-weight: bold;
            }

            span.roledesc {
                font-style: italic;
                display: inline-block;
            }

            span.stage {
                font-style: italic;
            }

            span.speaker-abbreviation {
                font-style: italic;
                display: inline-block;
                margin-right: 10px;
                margin-left: 10px;
            }

            .witness-meter {
                -webkit-box-align: center!important;
                -ms-flex-align: center!important;
                align-items: center!important;
                display: -webkit-box!important;
                display: -ms-flexbox!important;
                display: flex!important;
            }

            .variant-toggler, .variant-toggler:hover {
                text-decoration: none;
                color: #f99b4e;
            }

            .variant-row {
                /*background-color: #efefef;*/
                background-color: rgba(154, 154, 153, 0.1);
                border-bottom: solid 4px #fbeee0;
            }

            .witness-formula {
                color: #f99b4e;
                font-family: 'Roboto', sans-serif;
                font-size: 12px;
                text-transform: uppercase;
            }

            .variant-play-label {
                background-color: #f2f2f2;
            }

            .variant-words {
                font-family: 'Libre Baskerville', serif;
                color: #949494;
                padding-left: 37px;
                padding-top: 10px;
                padding-bottom: 5px;
            }

            .variant-note {
                color: #070707;
            }

            h3.heading {
                margin-top: 0px;
                margin-bottom: 0px;
            }

            span.difference {
                color: #e9702b;
                background-color: #d8d8d8;
            }

            comspan {
                background-color: rgba(144, 188, 226, .3);
                border-bottom: solid 1px rgb(144, 188, 226);
                cursor: pointer;
            }

            #search-widget {
                position: fixed;
                bottom: 0;
                width: 100%;
                z-index: 2000;
                pointer-events: none;
            }
        </style>

        <title>Winter's Tale</title>
    </head>
    <body>
        <div id="main-container" class="container-fluid h-100">

            <!-- MAIN HEADER -->
            <div id="main-header" class="row">

                <!-- NVS LOGO -->
                <div class="d-none d-lg-flex justify-content-center col-lg-1 pt-4 px-1">
                    <figure>
                    <img src="{% static 'img/nvs-logo.png'%}" class="img-fluid" style="max-height: 85px;">
                    </figure>
                </div>

                <!-- TEXT SETTINGS -->
                <div class="col-sm-12 col-md-5 col-lg-4">
                    <div class="heading-section-label">Text</div>
                    <div class="row p-1">
                        <div class="col-sm-12 bg-nvs-lightest-gray p-0 p-sm-2">
                            <div class="heading-label">PLAY</div>
                            <div class="nvs-selection">
                                <select id="play-selector" class="font-weight-bold">
                                    <option value="wt">The Winter's Tale</option>
                                </select>
                            </div>
                            <div class="row">
                                <!-- search play box -->
                                <div class="col-sm-6 pr-sm-1">
                                    <div id="hdr-quick-search-box" class="nvs-search" placeholder="SEARCH THIS PLAY" contentEditable="plaintext-only"></div>
                                </div>

                                <!-- play line no box -->
                                <div class="col-sm-4 p-sm-0">
                                    <input id="hdr-line-no-box" type="text" placeholder="ENTER LINE#" />
                                </div>

                                <!-- play go button -->
                                <div class="col-sm-2 pl-sm-1">
                                    <input type="button" value="GO">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FILTER SETTINGS -->
                <div class="col-sm-6 col-md-4">
                    <div class="heading-section-label">Filter</div>
                    <div class="row p-1">
                        <div class="col-sm-12 bg-nvs-lightest-gray p-0 p-sm-2">
                            <div class="row align-items-end">
                                <!-- act/scene -->
                                <div class="col-sm-5 pr-sm-1">
                                    <div class="heading-label">ACT, SCENE</div>
                                    <div class="nvs-selection">
                                        <select id="hdr-act-scene-selector">
                                            <option value="all">ALL</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- character -->
                                <div class="col-sm-5 p-sm-0">
                                    <div class="heading-label">CHARACTER</div>
                                    <div class="nvs-selection">
                                        <select id="hdr-character-selector">
                                            <option value="all">ALL</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- filter go button -->
                                <div class="col-sm-2 pl-sm-1">
                                    <input type="button" value="GO">
                                </div>
                            </div>

                            <div class="row">
                                <!-- advanced search -->
                                <div class="col-sm-12">
                                    <div class="nvs-search" placeholder="ADVANCED SEARCH" contentEditable="true"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW SETTINGS -->
                <div class="col-sm-6 col-md-3" style="border-right: solid 5px var(--nvs-background-color);">
                    <div class="heading-section-label">View</div>
                    <div class="row p-1">
                        <div class="col-sm-12 bg-nvs-lightest-gray p-0 p-sm-2">
                            <div class="row">
                                <div class="col-sm-7">
                                    <!-- reader view -->
                                    <label class="toggle-control">
                                        <input type="checkbox" checked="checked">
                                        <span class="control"></span>
                                        <span class="heading-label">READER</span>
                                    </label>

                                    <!-- list view -->
                                    <label class="toggle-control">
                                        <input type="checkbox">
                                        <span class="control"></span>
                                        <span class="heading-label">LIST</span>
                                    </label>

                                    <!-- chart view -->
                                    <label class="toggle-control">
                                        <input type="checkbox">
                                        <span class="control"></span>
                                        <span class="heading-label">CHART</span>
                                    </label>
                                </div>
                                <div class="col-sm-5">
                                    <input type="button" id="hdr-reset-button" class="nvs-secondary-button" value="RESET">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- QUANTITATIVE VIEW -->
            {% if nvs_session.preferences.show_quantitative_view %}
            <div id="quantitative-view" class="row no-gutters">
            </div>
            {% endif %}

            <!-- READER VIEW -->
            {% if nvs_session.preferences.show_reader_view %}
            <div id="reader-view" class="row flex-grow-1">
                <div id="main-col" class="col-md-12 col-lg-12 mt-2 p-1 view-col bg-nvs-lightest-gray">

                    <!-- header row -->
                    <div class="row">
                        <div class="d-none d-sm-block col-sm-3">
                            <div class="heading-section-label">READER VIEW</div>

                            <!-- witness header -->
                            <div id="witness-header">
                                <canvas id="witness-header-canvas"></canvas>
                            </div>
                        </div>

                        <!-- variant controls -->
                        <div class="col-sm-2 offset-sm-2 pl-sm-0 pr-sm-1">
                            <div class="heading-label">VARIANTS</div>
                            <div class="nvs-selection">
                                <select id="play-selector">
                                    <option value="all">SHOW PRIMARY</option>
                                </select>
                            </div>
                        </div>

                        <!-- commentary controls -->
                        <div class="col-sm-3 px-sm-0">
                            <div class="heading-label">COMMENTARY</div>
                            <div class="nvs-selection">
                                <select id="play-selector">
                                    <option value="all">SHOW NOTES & HIGHLIGHTS</option>
                                </select>
                            </div>
                        </div>

                        <!-- numbering controls -->
                        <div class="col-sm-2 pl-sm-1 pr-sm-0">
                            <div class="heading-label">NUMBERING</div>
                            <div class="nvs-selection">
                                <select id="play-selector">
                                    <option value="all">TLN</option>
                                </select>
                            </div>
                        </div>
                    </div>


                    <div class="row">
                        <!-- PLAYTEXT -->
                        <div id="playtext-col" class="col-sm-9 pr-0">
                            {% for line in lines %}
                                <div id="{{ line.xml_id }}-row"
                                     class="row no-gutters play-row offscreen"
                                     data-xml_id="{{ line.xml_id }}"
                                     data-line_number="{{ line.line_number }}"
                                     data-text="{{ line.text }}"
                                     data-text-length="{{ line.text|length }}"
                                     data-witness_indicators="{{ line.witness_meter }}"
                                >
                                    <div id="{{ line.xml_id }}-witness-col" class="col-sm-4 m-0 p-0 witness-meter">
                                        <canvas id="{{ line.xml_id }}-witness-meter" height="36px"></canvas>
                                    </div>
                                    <div id="{{ line.xml_id }}-number-col" class="col-sm-1 m-0 p-0 play-label">
                                        {% if line.witness_meter|to_int > 0 %}
                                            <a id="{{ line.xml_id }}-variant-toggler"
                                                   class="variant-toggler mx-1"
                                                   data-toggle="collapse"
                                                   href="#{{ line.xml_id }}-variant-div"
                                                   role="button"
                                                   aria-expanded="false"
                                                   aria-controls="{{ line.xml_id }}-variant-div"
                                                >
                                                <i id="{{ line.xml_id }}-variant-toggle" class="fas fa-chevron-circle-right"></i>
                                            </a>
                                        {% else %}
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        {% endif %}
                                        {{ line.line_label }}
                                    </div>
                                    <div id="{{ line.xml_id }}-text-col" class="col-sm-7 m-0 p-0 play-words offscreen">
                                        <span class="line-text">{{ line.text }}</span>
                                        <span class="line-html">{{ line.rendered_html|safe }}</span>
                                    </div>

                                </div>
                                {% if line.witness_meter|to_int > 0 %}
                                    <div class="collapse" class="variant-drawer" id="{{ line.xml_id }}-variant-div"></div>
                                {% endif %}
                            {% endfor %}

                        </div>

                        <!-- COMMENTARY -->
                        <div class="col-sm-3">
                            <!--
                            <div style="height: 100%; width: calc(25% - 5px); position: fixed;">
                                <iframe id="commentary-frame" width="100%" height="100%" frameborder="0" src="/corpus/{{ corpus_id }}/commentary-viewer/{{ play.prefix }}/"></iframe>
                            </div>
                            -->

                            <iframe id="commentary-frame" width="100%" height="100%" frameborder="0" src="/corpus/{{ corpus_id }}/commentary-viewer/{{ play.prefix }}/"></iframe>


                        </div>
                    </div>

                </div>
            </div>
            {% endif %}

            <!-- LIST VIEW -->
            {% if nvs_session.preferences.show_list_view %}
            <div id="quantitative-view" class="row no-gutters">
            </div>
            {% endif %}
        </div>
        <div id="search-widget" class="d-none container-fluid">
            <div class="row">
                <div class="col-sm-6 offset-sm-3">
                    <div class="d-flex flex-row justify-content-between align-items-center bg-nvs-lightest-gray" style="pointer-events: auto;">
                        <span>
                            Line Results
                            <a id="search-line-prev" onClick="display_search_result('line', 'prev');"><i class="fas fa-chevron-left"></i></a>
                            <span id="search-line-current">0</span> out of
                            <span id="search-line-total">0</span>
                            <a id="search-line-next" onClick="display_search_result('line', 'next');"><i class="fas fa-chevron-right"></i></a>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <script src="{% static 'js/jquery-3.3.1.min.js' %}"></script>
        <script src="{% static 'js/popper.min.js' %}"></script>
        <script src="{% static 'js/bootstrap.min.js' %}"></script>
        <script src="{% static 'js/jquery.mark.min.js' %}"></script>
        <script src="{% static 'js/corpora.js' %}"></script>
        <script type="application/javascript">
    let corpora;
    let corpus_id = "{{ corpus_id }}";
    let play_prefix = "{{ play.prefix }}";
    let play_id = "{{ play.id }}";
    let current_act_scene = "{{ nvs_session.filter.act_scene }}";
    let current_character = "{{ nvs_session.filter.character }}";
    let corpus;
    let screen_size = 'large';
    let meter_height = () => Math.round(window.innerHeight / (100 / 3)) + 'px';

    let witnesses, characters = null;
    let lines = {}, notes = {}, act_scenes = {};

    let witnesses_loaded = false, notes_loaded = false, characters_loaded = false;
    let redraw_timer = null;

    let note_search = {
        s_line_number: 'asc',
        s_xml_id: 'asc',
        page: 1,
        'page-size': 1000
    };
    let nvs_search = null;

    $(document).ready(function() {
        corpora = new Corpora({'csrf_token': "{{ csrf_token }}"});
        screen_size = determine_screen_size(window.innerWidth);
        $(":root").css("--scrollbarURL", `url(/corpus/${corpus_id}/play-minimap/${play_prefix}/?width=60&height=${parseInt($("#playtext-col").height())})`);

        corpora.list_content(
            corpus_id,
            'Document',
            {q_nvs_doc_type: 'witness', s_pub_date: 'asc', 'page-size': 1000},
            function(witness_data) {
                witnesses = witness_data.records;
                witnesses_loaded = true;
                draw_witness_header_and_background();
            }
        );

        // GET CHARACTER NAMES; POSSIBLY FILTERED BY ACT/SCENE
        let speech_params = {
            'page-size': 0,
            'a_terms_characters': 'speaking.xml_id,speaking.name',
        };
        if (current_act_scene !== 'all') {
            if (current_act_scene.includes('.')) {
                let [current_act, current_scene] = current_act_scene.split('.');
                speech_params['f_act'] = current_act;
                speech_params['f_scene'] = current_scene;
            } else {
                speech_params['f_act'] = current_act_scene;
            }
        }
        corpora.list_content(
            corpus_id,
            'Speech',
            speech_params,
            function(char_data) {
                if (char_data.hasOwnProperty('meta') && char_data.meta.hasOwnProperty('aggregations') && char_data.meta.aggregations.hasOwnProperty('characters')) {
                    let char_selector = $('#hdr-character-selector');
                    Object.keys(char_data.meta.aggregations.characters).map(char_id_name => {
                        let [char_xml_id, char_name] = char_id_name.split('|||');
                        let selected = current_character === char_xml_id ? ' selected' : '';
                        char_selector.append(`
                            <option value="${char_xml_id}"${selected}>${char_name}</option>
                        `);
                    });
                }
                characters_loaded = true;
            }
        );

        ingest_lines();
        configure_controls();

        corpora.list_content(
            corpus_id,
            'TextualNote',
            Object.assign({only: 'xml_id,variants,lines.xml_id'}, note_search),
            function(note_data) {
                note_data.records.map(note => {
                    notes[note.xml_id] = note;
                    notes[note.xml_id].populated = false;
                    note.lines.map(tn_line => {
                        if (lines.hasOwnProperty(tn_line.xml_id)) {
                            lines[tn_line.xml_id].notes.push(note.xml_id);
                        } else {
                            console.log(`Error: Unaccounted for TextualNote(${note.xml_id}) Line(${tn_line.xml_id})`);
                        }

                    });
                });
                notes_loaded = true;
            },
            true
        );

        setTimeout(wait_for_load, 500);
    });

    function configure_controls() {
        // HEADER: LINE# BOX
        $('#hdr-line-no-box').keypress(function(e) {
            if (e.which === 13) {
                let line_no = $('#hdr-line-no-box').val();
                if (`tln_${line_no}` in lines) {
                    $(`#tln_${line_no}-row`)[0].scrollIntoView({behavior: 'smooth'});
                }
            }
        });

        // HEADER: QUICK SEARCH BOX
        $('#hdr-quick-search-box').keypress(function(e) {
            if (e.which === 13) {
                let qs_box = $('#hdr-quick-search-box');
                let query = qs_box.text().trim();
                qs_box.empty();
                qs_box.html(query);
                corpora.make_request(
                    `/api/corpus/${corpus_id}/nvs-search/${play_prefix}/`,
                    'POST',
                    {
                        quick_search: query
                    },
                    process_search_results
                );
                return false;
            }
        });

        // HEADER: ACT, SCENE BOX
        $('#hdr-act-scene-selector').change(function() {
            let selection = $('#hdr-act-scene-selector').val();
            window.location = `/corpus/${corpus_id}/play-viewer/${play_prefix}/?act-scene=${selection}`;
        });

        // HEADER: CHARACTER BOX
        $('#hdr-character-selector').change(function() {
            let selection = $('#hdr-character-selector').val();
            window.location = `/corpus/${corpus_id}/play-viewer/${play_prefix}/?character=${selection}`;
        });

        // HEADER: RESET BUTTON
        $('#hdr-reset-button').click(function() {
            window.location = `?reset=true`;
        });

        // COMMENTARY HIGHLIHT CLICK
        $('comspan').click(function(e) {
            let comm_frame = $('#commentary-frame');
            let comm_id = this.className.replace('commentary-lemma-', '');
            comm_frame.contents().find(`#commentary-note-${comm_id}`)[0].scrollIntoView({behavior: 'smooth'});
            e.stopPropagation();
        });

        // VARIANT TOGGLER CLICK
        $('.variant-toggler').click(function() {
            let line_xml_id = this.id.replace('-variant-toggler', '');
            console.log(line_xml_id);
            if (!lines[line_xml_id].populated) {
                show_notes(line_xml_id);
            }
        });
    }

    function get_nvs_var(variable_name) {
        return getComputedStyle(document.documentElement).getPropertyValue(`--${variable_name}`);
    }

    function determine_screen_size(width) {
        if (width < 768) { return 'small'; }
        else if (width < 992) { return 'medium'; }
        return 'large';
    }

    function wait_for_load() {
        if (witnesses_loaded && characters_loaded && notes_loaded) {
            $('#playtext-col').scroll(function() {
                clearTimeout(redraw_timer);
                redraw_timer = setTimeout(flush_visibility_queue, 800);
            });

            Object.keys(lines).map(line_xml_id => {
                let line = lines[line_xml_id];
                draw_witness_meter(
                    line.witness_indicators,
                    line.witness_meter,
                    line.witness_column.clientWidth,
                    line.witness_column.clientHeight - 8
                );
            });
            flush_visibility_queue();
        } else {
            setTimeout(wait_for_load, 500);
        }
    }

    function flush_visibility_queue() {
        let visible_found = false;
        let visible_lines = [];

        for (let line_xml_id in lines) {
            let line = lines[line_xml_id];
            if(is_visible(line.row)) {
                visible_found = true;
                line.row.classList.remove('offscreen');
                line.row.classList.add('onscreen');
                line.visible = true;
                visible_lines.push(line_xml_id);
            } else if(visible_found) {
                break;
            }
        }

        for (let line_xml_id in lines) {
            let line = lines[line_xml_id];
            if (line.visible && !visible_lines.includes(line_xml_id)) {
                line.row.classList.remove('onscreen');
                line.row.classList.add('offscreen');
                line.visible = false;
            }
        }
    }

    function is_visible(el) {
        let rect = el.getBoundingClientRect();
        return (
            rect.bottom >= 0 &&
            rect.top <= (window.innerHeight || document.documentElement.clientHeight) + 500
        );
    }

    function show_notes(line_id) {
        let line_variant_div = $(`#${line_id}-variant-div`);
        let line_witness_meter = $(`#${line_id}-witness-meter`);

        line_variant_div.removeClass('hidden');
        line_witness_meter.removeClass('hidden');

        // make note/variant elements
        lines[line_id].notes.map(note_id => {
            if(!notes[note_id].populated) {
                notes[note_id].variants.map(variant => {
                    let variant_words = variant.variant;
                    if (!variant_words) {
                        if (variant.description === null) {
                            variant_words = `Error with variant transform: <a href='${notes[note_id].uri}/' target='_blank'>Note</a> <a href='${variant.uri}/' target='_blank'>Variant</a>`;
                        } else {
                            variant_words = `<span class="variant-note">${variant.description}</span>`;
                        }
                    }

                    notes[note_id].lines.map(line => {
                        if (line.xml_id in lines) {
                            $(`#${line.xml_id}-variant-div`).append(`
                                <div class="row no-gutters variant-row">
                                    <div class="col-sm-4 p-0 m-0">
                                        <div class="row no-gutters">
                                            <div id="variant-${variant.id}" class="col-sm-12 p-0 m-0 witness-meter">
                                                <canvas id="${line.xml_id}-${variant.id}-witness-meter"></canvas>
                                            </div>
                                        </div>
                                        <div class="row no-gutters">
                                            <div class="col-sm-12 witness-formula">
                                                ${variant.witness_formula}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-1 p-0 m-0 variant-play-label">&nbsp;</div>
                                    <div class="col-sm-7 p-0 m-0 variant-words">${variant_words}</div>
                                </div>
                            `);

                            $(`#${line.xml_id}-variant-div`).on('shown.bs.collapse', function (event) {
                                let indicator = $(`#${event.target.id.replace('-div', '-toggle')}`);
                                indicator.removeClass('fa-chevron-circle-right');
                                indicator.addClass('fa-chevron-circle-down');
                            });

                            $(`#${line.xml_id}-variant-div`).on('hidden.bs.collapse', function (event) {
                                let indicator = $(`#${event.target.id.replace('-div', '-toggle')}`);
                                indicator.removeClass('fa-chevron-circle-down');
                                indicator.addClass('fa-chevron-circle-right');
                            });

                            let variant_col = $(`#${line.xml_id}-witness-col`);
                            draw_witness_meter(
                                variant.witness_meter,
                                document.getElementById(`${line.xml_id}-${variant.id}-witness-meter`),
                                variant_col.outerWidth(),
                                25,
                                "#FFFFFF"
                            );
                        }
                    });
                });
                notes[note_id].populated = true;
            }
        });

        lines[line_id].populated = true;
    }

    function hide_notes(line_id) {
        let line_row = $(`#${line_id}-row`);
        let line_text_col = $(`#${line_id}-text-col`);
        let line_variant_toggler = $(`#${line_id}-variant-toggler`);
        let line_variant_div = $(`#${line_id}-variant-div`);
        let line_witness_meter = $(`#${line_id}-witness-meter`);

        line_variant_div.addClass('hidden');
        line_witness_meter.addClass('hidden');
        line_text_col.html(line_row.data('text'));
    }

    function process_search_results(results) {
        console.log(results);
        $(":root").css("--scrollbarURL", `url(/corpus/${corpus_id}/play-minimap/${play_prefix}/?width=60&height=${parseInt($("#playtext-col").height())}&no-cache=${Math.floor(Date.now() / 1000)})`);
        if (nvs_search && nvs_search.hasOwnProperty('line_results')) {
            nvs_search.line_results.map(result => {
                let html_span = $(`#${result.xml_id}-text-col > .line-html`);
                result.matches.map(match => html_span.unmark(match));
            });
        }

        nvs_search = {
            character_results: results.characters,
            line_results: results.lines,
            current_line_result: 0
        };

        $('#search-line-total').html(nvs_search.line_results.length);
        $('#search-widget').removeClass('d-none');

        nvs_search.line_results.map(result => {
            let html_span = $(`#${result.xml_id}-text-col > .line-html`);
            result.matches.map(match => html_span.mark(match));
        });
        
        display_search_result('line', 'next');
    }

    function display_search_result(type, which) {
        if (type === 'line') {
            if (which === 'next') {
                nvs_search.current_line_result += 1;
            } else {
                nvs_search.current_line_result -= 1;
            }

            let result = nvs_search.line_results[nvs_search.current_line_result - 1];
            document.getElementById(`${result.xml_id}-text-col`).scrollIntoView({behavior: 'smooth'});

            $('#search-line-current').html(nvs_search.current_line_result);
            if (nvs_search.current_line_result === 1) {
                $('#search-line-prev').addClass('d-none');
            } else {
                $('#search-line-prev').removeClass('d-none');
            }

            if (nvs_search.current_line_result === nvs_search.line_results.length) {
                $('#search-line-next').addClass('d-none');
            } else {
                $('#search-line-next').removeClass('d-none');
            }
        }
    }

    function draw_witness_header_and_background() {
        let witness_centuries = {};
        witnesses.map(wit => {
            let century = wit.pub_date[0] + wit.pub_date[1] + "00";
            if (!witness_centuries.hasOwnProperty(century)) {
                witness_centuries[century] = 1;
            } else {
                witness_centuries[century] += 1;
            }
        });

        let wit_header = $('#witness-header');
        let width = wit_header.width();
        let witness_width = width / witnesses.length;
        let header_height = wit_header.height();

        let header_canvas = $('#witness-header-canvas');
        header_canvas.attr('width', `${width}px`);
        header_canvas.attr('height', `${header_height}px`);
        let header_context = header_canvas[0].getContext('2d');
        let light_beige = get_nvs_var('nvs-light-beige');
        let dark_beige = get_nvs_var('nvs-dark-beige');
        let font_color = get_nvs_var('nvs-mid-gray');
        let font_size = 12;
        header_context.font = `${font_size}px Roboto`;
        header_context.textAlign = "left";
        header_context.textBaseline = "bottom";

        let playtext_col = $('#playtext-col');
        let background_canvas = document.createElement('canvas');
        background_canvas.height = playtext_col.innerHeight();
        background_canvas.width = width;
        let background_context = background_canvas.getContext('2d');

        let century_cursor = 0;
        let width_cursor = 0;
        for (let century in witness_centuries) {
            let century_width = witness_centuries[century] * witness_width;

            if (century_cursor % 2 === 0) {
                header_context.beginPath();
                header_context.fillStyle = dark_beige;
                header_context.fillRect(width_cursor, 0, century_width, header_height);

                background_context.beginPath();
                background_context.fillStyle = dark_beige;
                background_context.fillRect(width_cursor, 0, century_width, playtext_col.innerHeight());
            } else {
                header_context.beginPath();
                header_context.fillStyle = light_beige;
                header_context.fillRect(width_cursor, 0, century_width, header_height);

                background_context.beginPath();
                background_context.fillStyle = light_beige;
                background_context.fillRect(width_cursor, 0, century_width, playtext_col.innerHeight());
            }

            header_context.save();
            header_context.fillStyle = font_color;
            header_context.translate(width_cursor + 5, header_height - 5);
            header_context.rotate(-Math.PI / 2);
            header_context.fillText(century, 0, font_size);
            header_context.restore();

            century_cursor += 1;
            width_cursor += century_width;
        }

        playtext_col.css('background-image', `url(${background_canvas.toDataURL()})`);
        playtext_col.css('background-position', `${header_canvas.offset().left + 6}px 0px`);
    }

    function draw_witness_meter(witness_meter, canvas_element, width, height, inactive_color="#9A9A99") {
        let color_map = {
            '0': inactive_color,
            '1': '#f7bb78',
            '2': '#faae63',
            '3': '#f99b4e',
            '4': '#ef8537',
            '5': '#d87b48',
            '6': '#de6d4b',
            '7': '#bd5822',
            '8': '#a84f1f',
            '9': '#8f2d13',
        };

        canvas_element.setAttribute('width', width);
        canvas_element.setAttribute('height', height);
        let wm_context = canvas_element.getContext('2d');
        // line below turns on transparency
        // wm_context.globalAlpha = 0.7;
        let witness_width = width / witnesses.length;

        for (let meter_index = 0; meter_index < witness_meter.length; meter_index++) {
            wm_context.beginPath();
            wm_context.fillStyle = color_map[witness_meter[meter_index]];

            wm_context.fillRect(
                meter_index * witness_width,
                0,
                witness_width - 1,
                height
            );

        }
    }

    function romanize (num) {
        if (isNaN(num))
            return NaN;
        let digits = String(+num).split(""),
            key = ["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM",
                   "","X","XX","XXX","XL","L","LX","LXX","LXXX","XC",
                   "","I","II","III","IV","V","VI","VII","VIII","IX"],
            roman = "",
            i = 3;
        while (i--)
            roman = (key[+digits.pop() + (i * 10)] || "") + roman;
        return Array(+digits.join("") + 1).join("M") + roman;
    }

    // This function is a crude but hopefully effective method, performance-wise,
    // to populate lines data by allowing the Python backend to do the
    // heavy lifting.
    function ingest_lines() {
        {% for line in lines %}
        lines['{{ line.xml_id }}'] = {
            act: {% if line.act %}{{ line.act }}{% else %}0{% endif %},
            scene: {% if line.scene %}{{ line.scene }}{% else %}0{% endif %},
            notes: [],
            populated: false,
            visible: false,
            row: document.getElementById('{{ line.xml_id }}-row'),
            witness_indicators: '{{ line.witness_meter }}',
            witness_column: document.getElementById('{{ line.xml_id }}-witness-col'),
            witness_meter: document.getElementById('{{ line.xml_id }}-witness-meter'),
        };
        {% endfor %}

        Object.keys(lines).map(xml_id => {
            let act = lines[xml_id].act;
            let scene = lines[xml_id].scene;

            if (act > 0 && scene > 0) {
                let act_label = `${romanize(act)}`;
                if (!act_scenes.hasOwnProperty(act_label)) {
                    act_scenes[act_label] = `${act}`;
                }

                let label = `${romanize(act)}, ${scene}`;
                if (!act_scenes.hasOwnProperty(label)) {
                    act_scenes[label] = `${act}.${scene}`;
                }
            }
        });

        let act_scene_selector = $('#hdr-act-scene-selector');
        Object.keys(act_scenes).map(act_scene_label => {
            let selected = '';
            if (act_scenes[act_scene_label] === current_act_scene) {
                selected = ' selected'
            }

            act_scene_selector.append(`
                <option value="${act_scenes[act_scene_label]}"${selected}>${act_scene_label}</option>
            `);
        });
    }

    </script>
    </body>
</html>